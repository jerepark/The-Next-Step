<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Next Step</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
    #quick-add-btn {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 50;
      background-color: #059669;
      color: white;
      width: 56px;
      height: 56px;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    #quick-add-btn:hover {
      background-color: #047857;
      transform: scale(1.05);
    }
    #quick-add-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 100;
      justify-content: center;
      align-items: center;
    }
    #quick-add-modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      padding: 2rem;
      border-radius: 1rem;
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    .close-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .nav-btn.active {
      border-bottom: 4px solid #2563eb;
      color: #2563eb;
    }
    #notification-toast {
      position: fixed;
      bottom: 1rem;
      left: 50%;
      transform: translateX(-50%);
      background-color: #059669;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 9999px;
      font-weight: 600;
      display: none;
      z-index: 60;
    }
    #notification-toast.show {
      display: block;
      animation: fadeinout 3s ease forwards;
    }
    @keyframes fadeinout {
      0% { opacity: 0; transform: translateX(-50%) translateY(20px); }
      10% { opacity: 1; transform: translateX(-50%) translateY(0); }
      90% { opacity: 1; transform: translateX(-50%) translateY(0); }
      100% { opacity: 0; transform: translateX(-50%) translateY(20px); }
    }
    .home-button {
      background-color: #2563eb;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .home-button:hover {
      background-color: #1d4ed8;
      transform: translateY(-1px);
    }
    .action-item {
      transition: all 0.2s ease;
    }
    .action-item:hover {
      background-color: #f0fdf4;
    }
    .completed {
      text-decoration: line-through;
      opacity: 0.7;
    }
    .edit-btn {
      color: #3b82f6;
      cursor: pointer;
    }
    .edit-btn:hover {
      text-decoration: underline;
    }
    .clickable-item {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .clickable-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .resource-item {
      display: flex;
      justify-content: space-between;
      padding: 0.25rem 0;
    }
    .resource-has {
      color: #059669;
    }
    .resource-needs {
      color: #ef4444;
    }
    .convert-to-gameplan {
      background-color: #10b981;
      color: white;
      padding: 0.25rem 0.5rem;
      border-radius: 0.25rem;
      font-size: 0.75rem;
      margin-left: 0.5rem;
      transition: all 0.2s ease;
    }
    .convert-to-gameplan:hover {
      background-color: #059669;
    }
    .share-contact {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.25rem 0;
    }

    /* Mobile Menu specific styles */
    #mobile-menu-overlay {
      display: none; /* Hidden by default */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      z-index: 150; /* Above quick add modal */
      justify-content: center;
      align-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    #mobile-menu-overlay.active {
      display: flex;
      opacity: 1;
      visibility: visible;
    }
    .mobile-menu-content {
      background-color: white;
      width: 80%;
      max-width: 300px;
      padding: 2rem;
      border-radius: 1rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: relative;
      transform: translateY(20px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    #mobile-menu-overlay.active .mobile-menu-content {
      transform: translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <header class="bg-white shadow-md sticky top-0 z-40">
    <nav class="max-w-5xl mx-auto px-4">
      <div class="flex justify-between items-center h-16">
        <div class="flex items-center space-x-3">
          <div class="h-10 w-10 rounded-md bg-blue-600 flex items-center justify-center text-white font-bold">
            NS
          </div>
          <h1 class="text-xl font-extrabold text-blue-700">
            <i class="fas fa-forward mr-1"></i> The Next Step
          </h1>
        </div>
        <div class="hidden md:flex space-x-8 font-semibold text-gray-700">
          <button class="nav-btn active" data-tab="tab-home">
            <i class="fas fa-home mr-1"></i> Home
          </button>
          <button class="nav-btn" data-tab="tab-ideas">
            <i class="fas fa-lightbulb mr-1"></i> Idea Generation
          </button>
          <button class="nav-btn" data-tab="tab-gameplans">
            <i class="fas fa-chess mr-1"></i> Game Plans
          </button>
          <button class="nav-btn" data-tab="tab-export">
            <i class="fas fa-file-export mr-1"></i> Export & Share
          </button>
        </div>
        <button class="md:hidden text-gray-600" id="mobile-menu-btn">
          <i class="fas fa-bars fa-lg"></i>
        </button>
      </div>
    </nav>
  </header>

  <main class="max-w-5xl mx-auto px-4 py-6">
    <section id="tab-home" class="tab-content active">
      <h2 class="text-3xl font-extrabold text-gray-900 mb-6">
        <i class="fas fa-tachometer-alt text-blue-600 mr-2"></i>Dashboard
      </h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h3 class="text-2xl font-semibold text-blue-800 mb-4">
            <i class="fas fa-calendar-check mr-2"></i>Upcoming Actions
          </h3>
          <div id="upcoming-actions">
            <p class="text-gray-500">
              <i class="fas fa-info-circle mr-2"></i> No upcoming actions.
            </p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h3 class="text-2xl font-semibold text-green-700 mb-4">
            <i class="fas fa-chess mr-2"></i>Recent Game Plans
          </h3>
          <div id="gameplans-summary">
            <p class="text-gray-500">
              <i class="fas fa-info-circle mr-2"></i> No game plans available.
            </p>
          </div>
          <div class="mt-6 border-t pt-4">
            <h4 class="xl font-semibold text-gray-700 mb-3">Ideas Summary</h4>
            <div id="ideas-summary"></div>
          </div>
          <div class="mt-6 border-t pt-4">
            <h4 class="xl font-semibold text-gray-700 mb-3">Completed Items</h4>
            <div id="completed-summary"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-ideas" class="tab-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-extrabold text-gray-900">
          <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Idea Generation
        </h2>
        <button class="home-button" id="ideas-home-btn">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </button>
      </div>
      <form class="bg-white p-6 rounded-2xl shadow-md mb-8" id="idea-form">
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-brain mr-1 text-gray-500"></i> Idea Title
          </label>
          <input type="text" id="idea-title" class="w-full p-2 border rounded" placeholder="Enter your idea" required>
        </div>
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-align-left mr-1 text-gray-500"></i> Description
          </label>
          <textarea id="idea-description" class="w-full p-2 border rounded" rows="4" placeholder="Describe your idea"></textarea>
        </div>
        <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded">
          <i class="fas fa-plus-circle mr-1"></i> Add Idea
        </button>
      </form>
      <div id="ideas-list">
        <p class="text-gray-500 text-center">
          <i class="fas fa-info-circle mr-2"></i> No ideas added yet.
        </p>
      </div>
    </section>

    <section id="tab-gameplans" class="tab-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-extrabold text-gray-900">
          <i class="fas fa-chess text-green-600 mr-2"></i>Game Plans
        </h2>
        <button class="home-button" id="gameplans-home-btn">
          <i class="fas fa-home"></i>
          <span>Home</span>
        </button>
      </div>
      <form class="bg-white p-6 rounded-2xl shadow-md mb-8" id="gameplan-form">
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-flag-checkered mr-1 text-gray-500"></i> Game Plan Title
          </label>
          <input type="text" id="gp-title" class="w-full p-2 border rounded" placeholder="Enter your game plan" required>
        </div>
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-align-left mr-1 text-gray-500"></i> Description
          </label>
          <textarea id="gp-description" class="w-full p-2 border rounded" rows="3" placeholder="Describe your game plan"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-question-circle mr-1 text-gray-500"></i> Why is this important to me?
          </label>
          <textarea id="gp-importance" class="w-full p-2 border rounded" rows="2" placeholder="Explain why this matters to you"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-hourglass-end mr-1 text-gray-500"></i> Target Completion Date
          </label>
          <input type="date" id="gp-due-date" class="w-full p-2 border rounded" required>
        </div>
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-road mr-1 text-gray-500"></i> Potential Challenges/Roadblocks
          </label>
          <textarea id="gp-challenges" class="w-full p-2 border rounded" rows="2" placeholder="What might get in your way?"></textarea>
        </div>
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-tools mr-1 text-gray-500"></i> Resources
          </label>
          <div id="resources-container" class="mb-2 space-y-1"></div>
          <div class="flex space-x-2">
            <input type="text" id="new-resource" class="flex-1 p-2 border rounded" placeholder="Add a resource (hit plus)">
            <select id="resource-status" class="p-2 border rounded">
              <option value="has">I have</option>
              <option value="needs">I need</option>
            </select>
            <button type="button" id="add-resource-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-gray-800 font-semibold mb-2">
            <i class="fas fa-users mr-1 text-gray-500"></i> Who can I share this with?
          </label>
          <div id="share-contacts-container" class="mb-2 space-y-1"></div>
          <div class="flex">
            <input type="text" id="new-share-contact" class="flex-1 p-2 border rounded" placeholder="Add person or team (hit plus)">
            <button type="button" id="add-share-contact-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded ml-2">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <div class="mb-4">
          <h3 class="text-lg font-semibold text-gray-800 mb-2">
            <i class="fas fa-list-check mr-1 text-gray-500"></i> Action Plan
          </h3>
          <div id="action-items-container" class="space-y-2 mb-2"></div>
          <div class="flex space-x-2">
            <input type="text" id="new-action-item" class="flex-1 p-2 border rounded" placeholder="Add an action step">
            <input type="date" id="new-action-date" class="p-2 border rounded" placeholder="Date">
            <button type="button" id="add-action-btn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>
        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded">
          <i class="fas fa-plus-circle mr-1"></i> Add Game Plan
        </button>
      </form>
      <div id="gameplans-list">
        <p class="text-gray-500 text-center">
          <i class="fas fa-info-circle mr-2"></i> No game plans available.
        </p>
      </div>
    </section>

    <section id="tab-export" class="tab-content">
      <h2 class="text-3xl font-extrabold text-gray-900 mb-6">
        <i class="fas fa-file-export text-indigo-600 mr-2"></i>Export & Share
      </h2>
      <div class="bg-white p-6 rounded-2xl shadow-md">
        <button id="export-pdf-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded mr-4">
          <i class="fas fa-file-pdf mr-1"></i> Export to PDF
        </button>
        <button id="share-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded">
          <i class="fas fa-share-alt mr-1"></i> Share
        </button>
      </div>
    </section>
  </main>

  <button id="quick-add-btn">
    <i class="fas fa-plus fa-lg"></i>
  </button>

  <div id="quick-add-modal">
    <div class="modal-content">
      <button class="close-btn" id="close-modal">&times;</button>
      <h2 class="text-2xl font-bold mb-4">Quick Add</h2>
      <div class="flex flex-col space-y-4">
        <button class="bg-yellow-500 text-white py-3 px-6 rounded-lg flex items-center justify-center" id="add-idea-btn">
          <i class="fas fa-lightbulb mr-2"></i> New Idea
        </button>
        <button class="bg-green-600 text-white py-3 px-6 rounded-lg flex items-center justify-center" id="add-gameplan-btn">
          <i class="fas fa-chess mr-2"></i> New Game Plan
        </button>
      </div>
    </div>
  </div>

  <div id="mobile-menu-overlay">
    <div class="mobile-menu-content">
      <button class="close-btn" id="close-mobile-menu">&times;</button>
      <h2 class="text-2xl font-bold mb-6 text-gray-800">Menu</h2>
      <div class="flex flex-col space-y-4 font-semibold text-gray-700">
        <button class="nav-btn text-left py-2 px-4 rounded-lg hover:bg-gray-100" data-tab="tab-home">
          <i class="fas fa-home mr-2"></i> Home
        </button>
        <button class="nav-btn text-left py-2 px-4 rounded-lg hover:bg-gray-100" data-tab="tab-ideas">
          <i class="fas fa-lightbulb mr-2"></i> Idea Generation
        </button>
        <button class="nav-btn text-left py-2 px-4 rounded-lg hover:bg-gray-100" data-tab="tab-gameplans">
          <i class="fas fa-chess mr-2"></i> Game Plans
        </button>
        <button class="nav-btn text-left py-2 px-4 rounded-lg hover:bg-gray-100" data-tab="tab-export">
          <i class="fas fa-file-export mr-2"></i> Export & Share
        </button>
      </div>
    </div>
  </div>

  <div id="notification-toast"></div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize data
      let ideas = JSON.parse(localStorage.getItem('tns_ideas')) || [];
      let gameplans = JSON.parse(localStorage.getItem('tns_gameplans')) || [];
      let actionItems = [];
      let resources = [];
      let shareContacts = [];
      
      // Tab switching functionality
      function switchTab(tabName) {
        // Hide all tabs
        document.querySelectorAll('.tab-content').forEach(tab => {
          tab.classList.remove('active');
        });
        
        // Show selected tab
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Update active nav button
        document.querySelectorAll('.nav-btn').forEach(btn => {
          btn.classList.remove('active');
        });
        const navBtn = document.querySelector(`[data-tab="tab-${tabName}"]`);
        if (navBtn) navBtn.classList.add('active');
        
        // Render content when switching tabs
        if (tabName === 'home') renderDashboard();
        if (tabName === 'ideas') renderIdeas();
        if (tabName === 'gameplans') renderGamePlans();
      }
      
      // Set up home buttons
      document.getElementById('ideas-home-btn').addEventListener('click', function() {
        switchTab('home');
      });
      
      document.getElementById('gameplans-home-btn').addEventListener('click', function() {
        switchTab('home');
      });
      
      // Quick Add Modal functionality
      const quickAddBtn = document.getElementById('quick-add-btn');
      const quickAddModal = document.getElementById('quick-add-modal');
      const closeModalBtn = document.getElementById('close-modal');
      
      quickAddBtn.addEventListener('click', function() {
        quickAddModal.classList.add('active');
      });
      
      closeModalBtn.addEventListener('click', function() {
        quickAddModal.classList.remove('active');
      });
      
      document.getElementById('add-idea-btn').addEventListener('click', function() {
        quickAddModal.classList.remove('active');
        switchTab('ideas');
        document.getElementById('idea-title').focus();
      });
      
      document.getElementById('add-gameplan-btn').addEventListener('click', function() {
        quickAddModal.classList.remove('active');
        switchTab('gameplans');
        document.getElementById('gp-title').focus();
      });
      
      // Close modal when clicking outside
      quickAddModal.addEventListener('click', function(e) {
        if (e.target === quickAddModal) {
          quickAddModal.classList.remove('active');
        }
      });
      
      // Mobile Menu functionality (NEW)
      const mobileMenuBtn = document.getElementById('mobile-menu-btn');
      const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
      const closeMobileMenuBtn = document.getElementById('close-mobile-menu');

      mobileMenuBtn.addEventListener('click', function() {
        mobileMenuOverlay.classList.add('active');
      });

      closeMobileMenuBtn.addEventListener('click', function() {
        mobileMenuOverlay.classList.remove('active');
      });

      // Close mobile menu when a navigation item is clicked
      document.querySelectorAll('#mobile-menu-overlay .nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          mobileMenuOverlay.classList.remove('active');
        });
      });
      
      // Close mobile menu when clicking outside
      mobileMenuOverlay.addEventListener('click', function(e) {
        if (e.target === mobileMenuOverlay) {
          mobileMenuOverlay.classList.remove('active');
        }
      });

      // Show notification (for general app messages)
      function showNotification(message) {
        const toast = document.getElementById('notification-toast');
        toast.textContent = message;
        toast.classList.add('show');
        
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // --- Notification API Functions (NEW) ---
      function requestNotificationPermission() {
          if (!("Notification" in window)) {
              console.log("This browser does not support desktop notification");
              return;
          }

          if (Notification.permission === "default") {
              Notification.requestPermission().then(permission => {
                  if (permission === "granted") {
                      console.log("Notification permission granted.");
                  } else {
                      console.warn("Notification permission denied.");
                  }
              });
          } else if (Notification.permission === "granted") {
              console.log("Notification permission already granted.");
          } else { // denied
              console.warn("Notification permission previously denied.");
          }
      }

      function showNotificationsForUpcomingActions(upcomingActions) {
          if (Notification.permission !== "granted") {
              console.log("Cannot show notifications: permission not granted.");
              return;
          }

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          let notifiedActionIds = JSON.parse(localStorage.getItem('tns_notified_action_ids')) || [];

          upcomingActions.forEach(item => { // 'item' here is the object from the `upcoming` array
              if (!item.date) return; // Skip if no date

              const actionDueDate = new Date(item.date);
              actionDueDate.setHours(0, 0, 0, 0);

              // Check if the action is due today and hasn't been notified yet
              // Using a unique ID combining gameplanId and actionId to prevent duplicate notifications
              const uniqueNotificationId = `${item.gameplanId}-${item.actionId}`;

              if (actionDueDate.getTime() === today.getTime() && !notifiedActionIds.includes(uniqueNotificationId)) {
                  const notificationTitle = `Action Due Today: ${item.action}`;
                  const notificationOptions = {
                      body: `From Game Plan: ${item.title}\nDue: ${actionDueDate.toLocaleDateString()}`,
                      icon: 'https://cdn-icons-png.flaticon.com/512/2921/2921609.png' // You can replace this with your app's icon
                  };

                  try {
                      new Notification(notificationTitle, notificationOptions);
                      console.log(`Notification shown for: ${item.action}`);
                      notifiedActionIds.push(uniqueNotificationId); // Add to notified list
                  } catch (error) {
                      console.error("Error showing notification:", error);
                  }
              }
          });

          localStorage.setItem('tns_notified_action_ids', JSON.stringify(notifiedActionIds));
      }
      // --- End Notification API Functions ---
      
      // Resource management
      document.getElementById('add-resource-btn').addEventListener('click', function() {
        const resourceText = document.getElementById('new-resource').value.trim();
        const resourceStatus = document.getElementById('resource-status').value;
        
        if (resourceText) {
          const resourceItem = {
            id: Date.now(),
            text: resourceText,
            status: resourceStatus
          };
          
          resources.push(resourceItem);
          renderResources();
          
          document.getElementById('new-resource').value = '';
          document.getElementById('new-resource').focus();
        }
      });
      
      function renderResources() {
        const container = document.getElementById('resources-container');
        container.innerHTML = '';
        
        resources.forEach(resource => {
          const resourceElement = document.createElement('div');
          resourceElement.className = `resource-item ${resource.status === 'has' ? 'resource-has' : 'resource-needs'}`;
          resourceElement.innerHTML = `
            <span>
              <i class="fas ${resource.status === 'has' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-1"></i>
              ${resource.text}
            </span>
            <button class="text-gray-500 hover:text-red-500 delete-resource" data-id="${resource.id}">
              <i class="fas fa-times"></i>
            </button>
          `;
          container.appendChild(resourceElement);
        });
        
        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-resource').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            resources = resources.filter(r => r.id !== id);
            renderResources();
          });
        });
      }
      
      // Share contacts management
      document.getElementById('add-share-contact-btn').addEventListener('click', function() {
        const contactText = document.getElementById('new-share-contact').value.trim();
        
        if (contactText) {
          const contactItem = {
            id: Date.now(),
            name: contactText
          };
          
          shareContacts.push(contactItem);
          renderShareContacts();
          
          document.getElementById('new-share-contact').value = '';
          document.getElementById('new-share-contact').focus();
        }
      });
      
      function renderShareContacts() {
        const container = document.getElementById('share-contacts-container');
        container.innerHTML = '';
        
        shareContacts.forEach(contact => {
          const contactElement = document.createElement('div');
          contactElement.className = 'share-contact';
          contactElement.innerHTML = `
            <span>
              <i class="fas fa-user mr-1 text-gray-500"></i>
              ${contact.name}
            </span>
            <button class="text-gray-500 hover:text-red-500 delete-share-contact" data-id="${contact.id}">
              <i class="fas fa-times"></i>
            </button>
          `;
          container.appendChild(contactElement);
        });
        
        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-share-contact').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            shareContacts = shareContacts.filter(c => c.id !== id);
            renderShareContacts();
          });
        });
      }
      
      // Action items functionality
      document.getElementById('add-action-btn').addEventListener('click', function() {
        const actionText = document.getElementById('new-action-item').value.trim();
        const actionDate = document.getElementById('new-action-date').value;
        
        if (actionText) {
          const actionItem = {
            id: Date.now(),
            text: actionText,
            date: actionDate,
            completed: false
          };
          
          actionItems.push(actionItem);
          renderActionItems();
          
          document.getElementById('new-action-item').value = '';
          document.getElementById('new-action-date').value = '';
          document.getElementById('new-action-item').focus();
        }
      });
      
      function renderActionItems() {
        const container = document.getElementById('action-items-container');
        container.innerHTML = '';
        
        actionItems.forEach(item => {
          const itemElement = document.createElement('div');
          itemElement.className = `action-item flex items-center justify-between p-2 border rounded ${item.completed ? 'bg-gray-50' : ''}`;
          itemElement.innerHTML = `
            <div class="flex items-center">
              <input type="checkbox" ${item.completed ? 'checked' : ''} data-id="${item.id}" 
                class="mr-2 h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
              <span class="${item.completed ? 'completed' : ''}">${item.text}</span>
              ${item.date ? `<span class="ml-2 text-sm text-gray-500">${new Date(item.date).toLocaleDateString()}</span>` : ''}
            </div>
            <button class="text-red-500 hover:text-red-700 delete-action" data-id="${item.id}">
              <i class="fas fa-trash"></i>
            </button>
          `;
          container.appendChild(itemElement);
        });
        
        // Add event listeners for checkboxes
        document.querySelectorAll('#action-items-container input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const item = actionItems.find(i => i.id === id);
            if (item) {
              item.completed = this.checked;
              const textElement = this.nextElementSibling;
              if (item.completed) {
                textElement.classList.add('completed');
              } else {
                textElement.classList.remove('completed');
              }
            }
          });
        });
        
        // Add event listeners for delete buttons
        document.querySelectorAll('.delete-action').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            actionItems = actionItems.filter(item => item.id !== id);
            renderActionItems();
          });
        });
      }
      
      // Idea form submission
      document.getElementById('idea-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newIdea = {
          id: Date.now(),
          title: document.getElementById('idea-title').value,
          description: document.getElementById('idea-description').value,
          createdAt: new Date().toISOString(),
          completed: false
        };
        
        ideas.push(newIdea);
        localStorage.setItem('tns_ideas', JSON.stringify(ideas));
        
        this.reset();
        renderIdeas();
        renderDashboard();
        showNotification('Idea saved successfully!');
      });
      
      // Game plan form submission
      document.getElementById('gameplan-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newGamePlan = {
          id: Date.now(),
          title: document.getElementById('gp-title').value,
          description: document.getElementById('gp-description').value,
          importance: document.getElementById('gp-importance').value,
          dueDate: document.getElementById('gp-due-date').value,
          challenges: document.getElementById('gp-challenges').value,
          resources: [...resources],
          shareContacts: [...shareContacts],
          actions: [...actionItems],
          createdAt: new Date().toISOString(),
          completed: false
        };
        
        gameplans.push(newGamePlan);
        localStorage.setItem('tns_gameplans', JSON.stringify(gameplans));
        
        this.reset();
        actionItems = [];
        resources = [];
        shareContacts = [];
        renderActionItems();
        renderResources();
        renderShareContacts();
        renderGamePlans();
        renderDashboard();
        showNotification('Game plan saved successfully!');
      });
      
      // Convert idea to game plan
      function convertIdeaToGamePlan(ideaId) {
        const idea = ideas.find(i => i.id === ideaId);
        if (!idea) return;

        // Switch to Game Plans tab
        switchTab('gameplans');

        // Pre-fill the game plan form with idea data
        document.getElementById('gp-title').value = idea.title;
        document.getElementById('gp-description').value = idea.description || '';
        
        // Focus on the next field
        document.getElementById('gp-importance').focus();
        
        // Remove the idea if desired
        if (confirm('Convert this idea to a game plan and remove it from ideas?')) {
          ideas = ideas.filter(i => i.id !== ideaId);
          localStorage.setItem('tns_ideas', JSON.stringify(ideas));
          renderIdeas();
          renderDashboard();
        }
        
        showNotification('Idea converted to game plan!');
      }
      
      // Render functions
      function renderIdeas() {
        const ideasList = document.getElementById('ideas-list');
        ideasList.innerHTML = '';
        
        if (ideas.length === 0) {
          ideasList.innerHTML = `
            <p class="text-gray-500 text-center">
              <i class="fas fa-info-circle mr-2"></i> No ideas added yet.
            </p>
          `;
          return;
        }
        
        ideas.forEach(idea => {
          const ideaElement = document.createElement('div');
          ideaElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4 relative';
          
          if (idea.completed) {
            ideaElement.classList.add('bg-gray-50');
          }
          
          ideaElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center">
                  <input type="checkbox" ${idea.completed ? 'checked' : ''} data-id="${idea.id}" 
                    class="mr-2 h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                  <h3 class="text-xl font-semibold ${idea.completed ? 'text-gray-500 completed' : 'text-yellow-700'}">${idea.title}</h3>
                  <button class="convert-to-gameplan ml-2" data-id="${idea.id}">
                    <i class="fas fa-chess mr-1"></i> Make Game Plan
                  </button>
                </div>
                <p class="text-gray-700 mt-2 ${idea.completed ? 'completed' : ''}">${idea.description || 'No description'}</p>
                <p class="text-gray-500 text-sm mt-2">Created: ${new Date(idea.createdAt).toLocaleDateString()}</p>
              </div>
              <div class="flex space-x-2">
                <button class="edit-btn" data-id="${idea.id}" data-type="idea">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${idea.id}" data-type="idea">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
          ideasList.appendChild(ideaElement);
        });
        
        // Add event listeners for checkboxes
        document.querySelectorAll('#ideas-list input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const idea = ideas.find(i => i.id === id);
            if (idea) {
              idea.completed = this.checked;
              localStorage.setItem('tns_ideas', JSON.stringify(ideas));
              renderIdeas();
              renderDashboard();
            }
          });
        });
        
        // Add event listeners for edit buttons
        document.querySelectorAll('#ideas-list .edit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const type = this.getAttribute('data-type');
            if (type === 'idea') {
              editIdea(id);
            }
          });
        });
        
        // Add event listeners for delete buttons
        document.querySelectorAll('#ideas-list .delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const type = this.getAttribute('data-type');
            if (type === 'idea') {
              deleteIdea(id);
            }
          });
        });
        
        // Add event listeners for convert to game plan buttons
        document.querySelectorAll('.convert-to-gameplan').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            convertIdeaToGamePlan(id);
          });
        });
      }
      
      function editIdea(id) {
        const idea = ideas.find(i => i.id === id);
        if (!idea) return;
        
        document.getElementById('idea-title').value = idea.title;
        document.getElementById('idea-description').value = idea.description || '';
        
        // Remove the idea from the list
        ideas = ideas.filter(i => i.id !== id);
        localStorage.setItem('tns_ideas', JSON.stringify(ideas));
        
        // Focus on the title field
        document.getElementById('idea-title').focus();
        
        showNotification('Editing idea...');
      }
      
      function deleteIdea(id) {
        if (confirm('Are you sure you want to delete this idea?')) {
          ideas = ideas.filter(i => i.id !== id);
          localStorage.setItem('tns_ideas', JSON.stringify(ideas));
          renderIdeas();
          renderDashboard();
          showNotification('Idea deleted');
        }
      }
      
      function renderGamePlans() {
        const gameplansList = document.getElementById('gameplans-list');
        gameplansList.innerHTML = '';
        
        if (gameplans.length === 0) {
          gameplansList.innerHTML = `
            <p class="text-gray-500 text-center">
              <i class="fas fa-info-circle mr-2"></i> No game plans available.
            </p>
          `;
          return;
        }
        
        gameplans.forEach(gameplan => {
          const gameplanElement = document.createElement('div');
          gameplanElement.className = 'bg-white p-4 rounded-lg shadow-md mb-4 relative';
          
          if (gameplan.completed) {
            gameplanElement.classList.add('bg-gray-50');
          }
          
          // Count completed actions
          const completedActions = gameplan.actions ? gameplan.actions.filter(a => a.completed).length : 0;
          const totalActions = gameplan.actions ? gameplan.actions.length : 0;
          const progress = totalActions > 0 ? Math.round((completedActions / totalActions) * 100) : 0;
          
          gameplanElement.innerHTML = `
            <div class="flex justify-between items-start">
              <div class="flex-1">
                <div class="flex items-center">
                  <input type="checkbox" ${gameplan.completed ? 'checked' : ''} data-id="${gameplan.id}" 
                    class="mr-2 h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                  <h3 class="text-xl font-semibold ${gameplan.completed ? 'text-gray-500 completed' : 'text-green-700'}">${gameplan.title}</h3>
                </div>
                <p class="text-gray-700 mt-2 ${gameplan.completed ? 'completed' : ''}">${gameplan.description || 'No description'}</p>
                
                ${gameplan.importance ? `
                <div class="mt-2">
                  <h4 class="font-semibold text-gray-800">Why important:</h4>
                  <p class="text-gray-700 ${gameplan.completed ? 'completed' : ''}">${gameplan.importance}</p>
                </div>
                ` : ''}
                
                ${gameplan.dueDate ? `
                <div class="mt-2">
                  <h4 class="font-semibold text-gray-800">Target Date:</h4>
                  <p class="text-gray-700 ${gameplan.completed ? 'completed' : ''}">${new Date(gameplan.dueDate).toLocaleDateString()}</p>
                </div>
                ` : ''}
                
                ${gameplan.challenges ? `
                <div class="mt-2">
                  <h4 class="font-semibold text-gray-800">Potential Challenges:</h4>
                  <p class="text-gray-700 ${gameplan.completed ? 'completed' : ''}">${gameplan.challenges}</p>
                </div>
                ` : ''}
                
                ${gameplan.resources && gameplan.resources.length > 0 ? `
                <div class="mt-2">
                  <h4 class="font-semibold text-gray-800">Resources:</h4>
                  <ul class="space-y-1">
                    ${gameplan.resources.map(resource => `
                      <li class="${resource.status === 'has' ? 'resource-has' : 'resource-needs'}">
                        <i class="fas ${resource.status === 'has' ? 'fa-check-circle' : 'fa-exclamation-circle'} mr-1"></i>
                        ${resource.text}
                      </li>
                    `).join('')}
                  </ul>
                </div>
                ` : ''}
                
                ${gameplan.shareContacts && gameplan.shareContacts.length > 0 ? `
                <div class="mt-2">
                  <h4 class="font-semibold text-gray-800">Share With:</h4>
                  <ul class="space-y-1">
                    ${gameplan.shareContacts.map(contact => `
                      <li class="text-gray-700">
                        <i class="fas fa-user mr-1 text-gray-500"></i>
                        ${contact.name}
                      </li>
                    `).join('')}
                  </ul>
                </div>
                ` : ''}
                
                ${gameplan.actions && gameplan.actions.length > 0 ? `
                <div class="mt-3">
                  <h4 class="font-semibold text-gray-800">Action Plan (${completedActions}/${totalActions} completed):</h4>
                  <div class="w-full bg-gray-200 rounded-full h-2.5 mt-1">
                    <div class="bg-green-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                  </div>
                  <ul class="mt-2 space-y-1">
                    ${gameplan.actions.map(action => `
                      <li class="flex items-center">
                        <input type="checkbox" ${action.completed ? 'checked' : ''} disabled
                          class="mr-2 h-4 w-4 rounded border-gray-300 text-green-600 focus:ring-green-500">
                        <span class="${action.completed ? 'completed' : ''}">${action.text}</span>
                        ${action.date ? `<span class="ml-2 text-sm text-gray-500">${new Date(action.date).toLocaleDateString()}</span>` : ''}
                      </li>
                    `).join('')}
                  </ul>
                </div>
                ` : ''}
                
                <p class="text-gray-500 text-sm mt-2">Created: ${new Date(gameplan.createdAt).toLocaleDateString()}</p>
              </div>
              <div class="flex space-x-2">
                <button class="edit-btn" data-id="${gameplan.id}" data-type="gameplan">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="text-red-500 hover:text-red-700 delete-btn" data-id="${gameplan.id}" data-type="gameplan">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `;
          gameplansList.appendChild(gameplanElement);
        });
        
        // Add event listeners for checkboxes
        document.querySelectorAll('#gameplans-list input[type="checkbox"]').forEach(checkbox => {
          checkbox.addEventListener('change', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const gameplan = gameplans.find(g => g.id === id);
            if (gameplan) {
              gameplan.completed = this.checked;
              localStorage.setItem('tns_gameplans', JSON.stringify(gameplans));
              renderGamePlans();
              renderDashboard();
            }
          });
        });
        
        // Add event listeners for edit buttons
        document.querySelectorAll('#gameplans-list .edit-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const type = this.getAttribute('data-type');
            if (type === 'gameplan') {
              editGamePlan(id);
            }
          });
        });
        
        // Add event listeners for delete buttons
        document.querySelectorAll('#gameplans-list .delete-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const id = parseInt(this.getAttribute('data-id'));
            const type = this.getAttribute('data-type');
            if (type === 'gameplan') {
              deleteGamePlan(id);
            }
          });
        });
      }
      
      function editGamePlan(id) {
        const gameplan = gameplans.find(g => g.id === id);
        if (!gameplan) return;
        
        document.getElementById('gp-title').value = gameplan.title;
        document.getElementById('gp-description').value = gameplan.description || '';
        document.getElementById('gp-importance').value = gameplan.importance || '';
        document.getElementById('gp-due-date').value = gameplan.dueDate || '';
        document.getElementById('gp-challenges').value = gameplan.challenges || '';
        
        // Set resources
        resources = [...(gameplan.resources || [])];
        renderResources();
        
        // Set share contacts
        shareContacts = [...(gameplan.shareContacts || [])];
        renderShareContacts();
        
        // Set action items
        actionItems = [...(gameplan.actions || [])];
        renderActionItems();
        
        // Remove the gameplan from the list
        gameplans = gameplans.filter(g => g.id !== id);
        localStorage.setItem('tns_gameplans', JSON.stringify(gameplans));
        
        // Focus on the title field
        document.getElementById('gp-title').focus();
        
        showNotification('Editing game plan...');
      }
      
      function deleteGamePlan(id) {
        if (confirm('Are you sure you want to delete this game plan?')) {
          gameplans = gameplans.filter(g => g.id !== id);
          localStorage.setItem('tns_gameplans', JSON.stringify(gameplans));
          renderGamePlans();
          renderDashboard();
          showNotification('Game plan deleted');
        }
      }
      
      function renderDashboard() {
        const upcomingActions = document.getElementById('upcoming-actions');
        const gameplansSummary = document.getElementById('gameplans-summary');
        const ideasSummary = document.getElementById('ideas-summary');
        const completedSummary = document.getElementById('completed-summary');
        
        // Upcoming Actions (show all incomplete actions with a future/current date)
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Normalize today to start of day

        const upcoming = [];
        gameplans.forEach(gameplan => {
          if (gameplan.actions) {
            gameplan.actions.forEach(action => {
              if (action.date && !action.completed) {
                const actionDate = new Date(action.date);
                actionDate.setHours(0, 0, 0, 0); // Normalize action date to start of day
                if (actionDate >= today) { 
                  upcoming.push({
                    title: gameplan.title,
                    action: action.text,
                    actionId: action.id, // Added for unique notification tracking
                    date: action.date,
                    gameplanId: gameplan.id
                  });
                }
              }
            });
          }
        });
        
        if (upcoming.length > 0) {
          upcoming.sort((a, b) => new Date(a.date) - new Date(b.date));
          upcomingActions.innerHTML = `
            <div class="space-y-2">
              ${upcoming.slice(0, 5).map(item => `
                <div class="p-2 bg-blue-50 rounded-lg clickable-item" data-id="${item.gameplanId}">
                  <div class="font-medium">${item.action}</div>
                  <div class="text-sm text-blue-700">From: ${item.title}</div>
                  <div class="text-xs text-gray-500">Due: ${new Date(item.date).toLocaleDateString()}</div>
                </div>
              `).join('')}
            </div>
          `;
          
          // Add click events to upcoming actions
          document.querySelectorAll('#upcoming-actions .clickable-item').forEach(item => {
            item.addEventListener('click', function() {
              const gameplanId = parseInt(this.getAttribute('data-id'));
              switchTab('gameplans');
              editGamePlan(gameplanId);
            });
          });
        } else {
          upcomingActions.innerHTML = `
            <p class="text-gray-500">
              <i class="fas fa-info-circle mr-2"></i> No upcoming actions.
            </p>
          `;
        }

        // --- Trigger Notifications (NEW) ---
        showNotificationsForUpcomingActions(upcoming);
        // --- End Trigger Notifications ---
        
        // Game Plans Summary
        if (gameplans.length > 0) {
          gameplansSummary.innerHTML = ''; // Clear existing content
          // Sort gameplans by creation date in descending order to show most recent first
          const recentGamePlans = [...gameplans].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

          recentGamePlans.slice(0, 3).forEach(gameplan => { // Slice after sorting
            const completedActions = gameplan.actions ? gameplan.actions.filter(a => a.completed).length : 0;
            const totalActions = gameplan.actions ? gameplan.actions.length : 0;
            const progress = totalActions > 0 ? Math.round((completedActions / totalActions) * 100) : 0;
            
            const element = document.createElement('div');
            element.className = 'mb-3 p-3 bg-green-50 rounded-lg clickable-item';
            element.setAttribute('data-id', gameplan.id);
            element.innerHTML = `
              <h4 class="font-semibold text-green-800">${gameplan.title}</h4>
              <p class="text-sm text-green-700">${gameplan.dueDate ? 'Due: ' + new Date(gameplan.dueDate).toLocaleDateString() : ''}</p>
              ${totalActions > 0 ? `
              <div class="mt-1">
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="bg-green-600 h-2 rounded-full" style="width: ${progress}%"></div>
                </div>
                <div class="text-xs text-gray-600 mt-1">${completedActions}/${totalActions} actions</div>
              </div>
              ` : ''}
            `;
            gameplansSummary.appendChild(element); // Append directly
          });

          // Re-attach event listeners after direct appends
          document.querySelectorAll('#gameplans-summary .clickable-item').forEach(item => {
            item.addEventListener('click', function() {
              switchTab('gameplans');
              editGamePlan(item.getAttribute('data-id'));
            });
          });

        } else {
          gameplansSummary.innerHTML = `
            <p class="text-gray-500">
              <i class="fas fa-info-circle mr-2"></i> No game plans available.
            </p>
          `;
        }
        
        // Ideas Summary
        if (ideas.length > 0) {
          ideasSummary.innerHTML = '';
          ideas.slice(0, 3).forEach(idea => {
            const element = document.createElement('div');
            element.className = `mb-3 p-3 rounded-lg clickable-item ${idea.completed ? 'bg-gray-100' : 'bg-yellow-50'}`;
            element.setAttribute('data-id', idea.id);
            element.innerHTML = `
              <h4 class="font-semibold ${idea.completed ? 'text-gray-500' : 'text-yellow-800'}">${idea.title}</h4>
              <p class="text-sm ${idea.completed ? 'text-gray-500' : 'text-yellow-700'}">${idea.description ? idea.description.substring(0, 50) + (idea.description.length > 50 ? '...' : '') : ''}</p>
              ${idea.completed ? '<span class="text-xs text-green-600">Completed</span>' : ''}
            `;
            ideasSummary.appendChild(element);
            
            // Add click event to navigate to idea
            element.addEventListener('click', function() {
              switchTab('ideas');
              editIdea(idea.id);
            });
          });
        }
        
        // Completed Items
        const completedIdeas = ideas.filter(i => i.completed).length;
        const completedGameplans = gameplans.filter(g => g.completed).length;
        
        if (completedIdeas > 0 || completedGameplans > 0) {
          completedSummary.innerHTML = `
            <div class="grid grid-cols-2 gap-2">
              <div class="bg-green-50 p-3 rounded-lg">
                <div class="text-lg font-semibold text-green-800">${completedGameplans}</div>
                <div class="text-sm text-green-700">Game Plans</div>
              </div>
              <div class="bg-yellow-50 p-3 rounded-lg">
                <div class="text-lg font-semibold text-yellow-800">${completedIdeas}</div>
                <div class="text-sm text-yellow-700">Ideas</div>
              </div>
            </div>
          `;
        } else {
          completedSummary.innerHTML = `
            <p class="text-gray-500">
              <i class="fas fa-info-circle mr-2"></i> No completed items.\
            </p>
          `;
        }
      }
      
      // Set up tab buttons
      document.querySelectorAll('.nav-btn').forEach(button => {
        button.addEventListener('click', function() {
          const tabName = this.getAttribute('data-tab').replace('tab-', '');
          switchTab(tabName);
        });
      });
      
      // Initialize with Home tab
      switchTab('home');

      // Request notification permission when the page loads
      requestNotificationPermission();
    });
  </script>
</body>
</html>
